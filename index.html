<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IncretinA i Pro: Clinical Master Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        :root {
            --primary: #2563eb; --success: #10b981; --danger: #ef4444; --gray: #64748b; --dark: #0f172a; --accent: #fbbf24;
        }
        body { font-family: 'Pretendard', sans-serif; background: #f8fafc; color: var(--dark); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 800px; width: 100%; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; width: 100%; }
        
        .help-btn { 
            background: var(--accent); color: var(--dark); border: none; width: 50px; height: 50px; border-radius: 18px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
            transition: 0.3s;
        }
        .help-btn:hover { transform: scale(1.1) rotate(5deg); }

        /* ì‹¤ì‹œê°„ ì§€í‘œ ëŒ€ì‹œë³´ë“œ */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 25px; width: 100%; }
        .stat-item { background: white; padding: 15px; border-radius: 20px; text-align: center; border: 1px solid #e2e8f0; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .stat-val { display: block; font-size: 1.2rem; font-weight: 800; color: var(--primary); }
        .stat-lbl { font-size: 0.65rem; color: var(--gray); font-weight: 700; margin-bottom: 4px; display: block; }

        /* AI ë„›ì§€ ì¹´ë“œ */
        .ai-card { background: white; border-radius: 24px; padding: 25px; margin-bottom: 25px; border: 2px solid var(--primary); box-shadow: 0 10px 25px rgba(37, 99, 235, 0.1); width: 100%; box-sizing: border-box; }
        .ai-title { font-weight: 800; color: var(--primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; }
        .ai-content { background: #f8fafc; padding: 15px; border-radius: 12px; font-size: 0.95rem; line-height: 1.6; border-left: 4px solid var(--primary); font-style: italic; }

        /* ì‹œê°í™” ëŒ€ì‹œë³´ë“œ */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; width: 100%; }
        .chart-card { background: white; border-radius: 24px; padding: 20px; border: 2px solid #e2e8f0; }
        .chart-title { font-size: 0.8rem; font-weight: 800; margin-bottom: 10px; display: block; color: var(--gray); }

        /* ì…ë ¥ ë° ë¦¬ìŠ¤íŠ¸ */
        .glass-card { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 25px; width: 100%; box-sizing: border-box; }
        .profile-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .input-group label { font-size: 0.7rem; font-weight: 700; color: var(--gray); display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; font-family: inherit; font-weight: 600; box-sizing: border-box; }

        .item { background: white; border-radius: 20px; padding: 18px; margin-bottom: 12px; display: flex; gap: 12px; border-left: 6px solid #cbd5e1; cursor: pointer; transition: 0.2s; position: relative; }
        .item.checked { background: #f0fdf4; border-left-color: var(--success); }
        .item.critical { border-left-color: var(--danger); }
        
        .score-badge { position: absolute; right: 15px; top: 15px; background: #f1f5f9; padding: 4px 8px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; color: var(--gray); }
        .checked .score-badge { background: var(--success); color: white; }

        .btn { padding: 16px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; color: white; text-align: center; }
        .btn-primary { background: var(--primary); width: 100%; }

        /* ê°€ì´ë“œ ëª¨ë‹¬ ê³ ë„í™” */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 95%; max-width: 700px; padding: 35px; border-radius: 32px; max-height: 85vh; overflow-y: auto; }
        .guide-step { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #f1f5f9; }
        .guide-time { color: var(--primary); font-weight: 800; font-size: 1.2rem; margin-bottom: 5px; display: block; }
        .guide-title { font-size: 1.1rem; font-weight: 800; color: var(--dark); margin-bottom: 10px; display: block; }
        .guide-box { background: #f8fafc; padding: 15px; border-radius: 15px; border-left: 4px solid var(--accent); }
        .guide-label { font-size: 0.75rem; font-weight: 800; color: var(--gray); text-transform: uppercase; margin-bottom: 4px; display: block; }
        .guide-text { font-size: 0.9rem; line-height: 1.6; color: #334155; }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1 style="color: var(--primary); margin: 0; font-size: 1.5rem;">ğŸ§¬ IncretinA i Pro</h1>
            <p style="color: var(--gray); font-size: 0.8rem; margin-top: 5px;">v2.6 Precision Clinical Edition</p>
        </div>
        <button class="help-btn no-print" onclick="toggleModal('help-modal')">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A5 5 0 0 0 8 8c0 1.3.5 2.6 1.5 3.5.8.8 1.3 1.5 1.5 2.5"></path><line x1="9" y1="18" x2="15" y2="18"></line><line x1="10" y1="22" x2="14" y2="22"></line></svg>
        </button>
    </header>

    <div class="stat-grid no-print">
        <div class="stat-item"><span class="stat-lbl">í˜„ì¬ BMI</span><span class="stat-val" id="bmi-v">0.0</span></div>
        <div class="stat-item"><span class="stat-lbl">ëª©í‘œ ë‹¬ì„±ë¥ </span><span class="stat-val" id="ach-v" style="color:var(--danger);">0%</span></div>
        <div class="stat-item"><span class="stat-lbl">ìˆœì‘ë„ ì ìˆ˜</span><span class="stat-val" id="today-score">0</span></div>
        <div class="stat-item"><span class="stat-lbl">ì§€ë°©ì—°ì†Œ ê°€ì†</span><span class="stat-val" id="burn-rate" style="color:var(--success);">0%</span></div>
    </div>

    <div class="ai-card">
        <div class="ai-title">
            <select id="ai-persona" onchange="updateAIStatus()" style="border:none; font-weight:800; color:var(--primary); background:transparent; font-size:1.1rem; cursor:pointer;">
                <option value="clinical">ğŸ”¬ ì„ìƒ ì „ë¬¸ê°€ ì²˜ë°©</option>
                <option value="driver">ğŸ”¥ ê²°ê³¼ ì§€í–¥ ì½”ì¹­</option>
                <option value="empathetic">ğŸ¤ ê³µê° íŒŒíŠ¸ë„ˆ ë„›ì§€</option>
            </select>
        </div>
        <div id="ai-nudge" class="ai-content">ë°ì´í„° ë¶„ì„ì„ ìœ„í•´ ë£¨í‹´ì„ ê¸°ë¡í•´ ì£¼ì„¸ìš”.</div>
    </div>

    <div class="dashboard-grid no-print">
        <div class="chart-card" id="sim-view" style="display:none; border-color: var(--success);"><span style="font-size:0.7rem; font-weight:800; color:var(--gray);">ğŸ“‰ IMEM 4ì£¼ ì˜ˆì¸¡</span><canvas id="simChart" height="200"></canvas></div>
        <div class="chart-card" id="trend-view" style="display:none; border-color: var(--primary);"><span style="font-size:0.7rem; font-weight:800; color:var(--gray);">ğŸ“ˆ ì‹¤ì œ ì²´ì¤‘ ì¶”ì´</span><canvas id="trendChart" height="200"></canvas></div>
    </div>

    <div class="glass-card">
        <div class="profile-grid no-print">
            <div class="input-group"><label>ì±Œë¦°ì§€ ì‹œì‘ì¼</label><input type="date" id="p-start"></div>
            <div class="input-group"><label>ë‹¹ë‡¨ ìœ ë¬´</label><select id="p-diabetic"><option value="no">ë¹„ë‹¹ë‡¨ì¸</option><option value="yes">ë‹¹ë‡¨(ì œ2í˜•)</option></select></div>
            <div class="input-group"><label>í‚¤ (cm)</label><input type="number" id="p-h" value="175"></div>
            <div class="input-group"><label>ì‹œì‘ ì²´ì¤‘(kg)</label><input type="number" id="p-sw" step="0.1" value="80"></div>
            <div class="input-group"><label>í˜„ì¬ ì²´ì¤‘(kg)</label><input type="number" id="p-cw" step="0.1" value="78.5"></div>
            <div class="input-group"><label>ëª©í‘œ ì²´ì¤‘(kg)</label><input type="number" id="p-gw" step="0.1" value="70"></div>
            <div class="input-group"><label>ì£¼ê°„ ìš´ë™(íšŒ)</label><input type="number" id="p-exercise" value="3"></div>
        </div>
        <button class="btn btn-primary" onclick="runComprehensiveAnalysis()">ë¶„ì„ ì‹¤í–‰ ë° ë°ì´í„° ê°±ì‹ </button>
    </div>

    <div class="glass-card no-print" style="border-top: 4px solid var(--primary);">
        <div style="display:flex; gap:10px; align-items: flex-end; margin-bottom:15px;">
            <div style="flex:1;"><label style="font-size:0.7rem; font-weight:700; color:var(--gray);">ê¸°ë¡ ë‚ ì§œ</label><input type="date" id="target-date"></div>
            <div style="flex:1;"><label style="font-size:0.7rem; font-weight:700; color:var(--gray);">ì˜¤ëŠ˜ ì²´ì¤‘(kg)</label><input type="number" id="daily-weight" step="0.1" placeholder="00.0"></div>
        </div>
        <div id="routine-list"></div>
        <button class="btn" style="background:var(--success); width:100%; margin-top:20px;" onclick="exportToExcel()">ğŸ“Š ì„ìƒ ë°ì´í„° Excel ì¶”ì¶œ</button>
    </div>
</div>

<div id="help-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <h2 style="color:var(--primary); margin:0;">ğŸ”¬ 24h ì •ë°€ ëŒ€ì‚¬ ê°€ì´ë“œ</h2>
            <button onclick="toggleModal('help-modal')" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div id="modal-guide-body"></div>
    </div>
</div>

<script>
    // [24ì‹œê°„ ì •ë°€ ë£¨í‹´ ë°ì´í„° - ê°€ì´ë“œ ë³¸ë¬¸ í¬í•¨]
    const routine = [
        { 
            t: "07:00", title: "ìƒì²´ ë¦¬ë“¬ ë¦¬ì…‹ (Circadian Sync)", pts: 5, 
            action: "ê¸°ìƒ 10ë¶„ ë‚´ ì§ì‚¬ê´‘ì„  5ë¶„ + ë¬¼ 300ml", 
            detail: "ë§ë§‰ìœ¼ë¡œ ìœ ì…ëœ í–‡ë¹›ì€ ë©œë¼í† ë‹Œì„ ì°¨ë‹¨í•˜ê³  ì„¸ë¡œí† ë‹Œ í•©ì„±ì„ ìœ ë„í•˜ì—¬ ë‡Œì˜ ìƒì²´ ì‹œê³„ë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤. ì´ëŠ” ì˜¤ì „ ì¸ìŠë¦° ê°ìˆ˜ì„±ì„ ë†’ì´ê³  GLP-1 ë¶„ë¹„ íš¨ìœ¨ì„ ê²°ì •í•˜ëŠ” ê¸°ì´ˆ ê³µì‚¬ì…ë‹ˆë‹¤." 
        },
        { 
            t: "08:30", title: "ì»¤í”¼ ëŒ€ì‚¬ ë¶€ìŠ¤íŠ¸ (Coffee Boost)", pts: 5, 
            action: "ì—…ë¬´ ì‹œì‘ ì „ ë¬´ê°€ë‹¹ ë¸”ë™ì»¤í”¼ 1ì”", 
            detail: "ì»¤í”¼ì˜ í´ë¡œë¡œê²ì‚°ì€ ì†Œì¥ í•˜ë¶€ L-ì„¸í¬ë¥¼ ìê·¹í•´ ë‚´ì¸ì„± GLP-1 ë¶„ë¹„ë¥¼ ì˜ˆì—´í•©ë‹ˆë‹¤. ì¹´í˜ì¸ì€ êµê°ì‹ ê²½ì„ ìê·¹í•´ ê°ˆìƒ‰ì§€ë°©ì˜ ì—´ ë°œìƒ(Thermogenesis)ì„ ìœ ë„í•©ë‹ˆë‹¤." 
        },
        { 
            t: "09:00", title: "14h ë‹¨ì‹ í•´ì œ (Fast Break)", pts: 10, 
            action: "ì²« ìŒì‹ ì„­ì·¨ + ë² ë¥´ë² ë¦° ë³µìš©", 
            detail: "14ì‹œê°„ ê³µë³µ í›„ ì¸ìŠë¦° ê°ìˆ˜ì„±ì´ ì •ì ì¼ ë•Œ ë² ë¥´ë² ë¦°ì„ íˆ¬ì…í•˜ë©´ AMPK íš¨ì†Œê°€ ê°•ë ¥í•˜ê²Œ í™œì„±í™”ë˜ì–´ ì„¸í¬ì˜ ì—ë„ˆì§€ ì„¼ì„œë¥¼ ì¼œê³  ì¸ìŠë¦° ì €í•­ì„±ì„ ê°œì„ í•©ë‹ˆë‹¤." 
        },
        { 
            t: "11:00", title: "í˜¸ë¥´ëª¬ í”„ë¦¬ë¡œë“œ (Preload)", pts: 10, crit: true, 
            action: "ì ì‹¬ 30ë¶„ ì „ ë‹¨ë°±ì§ˆ 15g + PHGG 5g", 
            detail: "ì‹ì´ì„¬ìœ ì™€ ë‹¨ë°±ì§ˆì´ ì†Œì¥ì— ë¨¼ì € ë„ì°©í•˜ë©´ GLP-1ì´ ì„ ì œ ë¶„ë¹„ë©ë‹ˆë‹¤. ì‹ì‚¬ê°€ ì‹œì‘ë  ë•Œ í˜ˆë‹¹ ìŠ¤íŒŒì´í¬ë¥¼ ë§‰ëŠ” 'í˜¸ë¥´ëª¬ ë°©íŒŒì œ'ë¥¼ êµ¬ì¶•í•˜ì—¬ ì‹ê³¤ì¦ê³¼ í­ì‹ì„ ì›ì²œ ì°¨ë‹¨í•©ë‹ˆë‹¤." 
        },
        { 
            t: "12:00", title: "ì¸í¬ë ˆí‹´ ì‹œí€€ìŠ¤ (Sequence)", pts: 15, crit: true, 
            action: "ì±„ì†Œ â†’ ë‹¨ë°±ì§ˆ â†’ íƒ„ìˆ˜í™”ë¬¼ ìˆœì„œ ê³ ìˆ˜", 
            detail: "ì˜ì–‘ì†Œ ì…ë ¥ ìˆœì„œë¥¼ ë°”ê¾¸ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ìœ„ ë°°ì¶œ ì†ë„ê°€ ë¬¼ë¦¬ì ìœ¼ë¡œ ì§€ì—°ë©ë‹ˆë‹¤. íƒ„ìˆ˜í™”ë¬¼ì´ ê°€ì¥ ë§ˆì§€ë§‰ì— í¡ìˆ˜ë˜ì–´ ì¸ìŠë¦° ìŠ¤íŒŒì´í¬ë¥¼ ìµœì†Œí™”í•˜ê³  ì¸í¬ë ˆí‹´ íš¨ìœ¨ì„ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤." 
        },
        { 
            t: "12:50", title: "ê¸€ë£¨ì½”ìŠ¤ í´ë¦¬ì–´ëŸ°ìŠ¤ (Walk)", pts: 15, crit: true, 
            action: "ì‹í›„ 40ë¶„ ì´ë‚´ ë¹ ë¥¸ ê±·ê¸° 40ë¶„", 
            detail: "ì¸ìŠë¦°ì˜ ë„ì›€ ì—†ì´ë„ ê·¼ìœ¡ì˜ GLUT4 ìˆ˜ìš©ì²´ë¥¼ ê°•ì œ í™œì„±í™”í•˜ì—¬ í˜ˆì•¡ ì† í¬ë„ë‹¹ì„ ì§ì ‘ ì—°ì†Œì‹œí‚¤ëŠ” ë§ˆë²•ì˜ ê³¨ë“ íƒ€ì„ì…ë‹ˆë‹¤. ë‹¹ë¶„ì´ ì§€ë°©ìœ¼ë¡œ ì €ì¥ë˜ëŠ” ê²½ë¡œë¥¼ ì¦‰ì‹œ ì°¨ë‹¨í•©ë‹ˆë‹¤." 
        },
        { 
            t: "19:00", title: "ì €ë… ë§ˆê° (Metabolic Switch)", pts: 20, crit: true, 
            action: "19ì‹œ ì´ì „ ë§ˆì§€ë§‰ ì‹ì‚¬ ì™„ë£Œ í›„ ë‹¨ì‹", 
            detail: "ì¸ìŠë¦° ë†ë„ë¥¼ ê¸°ì € ìˆ˜ì¤€ìœ¼ë¡œ ë‚®ì¶”ì–´ ì‹ ì²´ë¥¼ 'ì €ì¥ ëª¨ë“œ'ì—ì„œ 'ì§€ë°© ì—°ì†Œ ëª¨ë“œ'ë¡œ ê°•ì œ ì „í™˜ì‹œí‚µë‹ˆë‹¤. ì•¼ê°„ 14ì‹œê°„ ë‹¨ì‹ì€ ì²´ì§€ë°© ê°ì†Œìœ¨ì„ ê²°ì •í•˜ëŠ” ê°€ì¥ í•µì‹¬ ë³€ìˆ˜ì…ë‹ˆë‹¤." 
        },
        { 
            t: "20:30", title: "ê·¼ìœ¡ ë°©ì–´ ë³´í˜¸ë§‰ (Muscle Shield)", pts: 10, 
            action: "ìŠ¤ì¿¼íŠ¸ ë“± ëŒ€ê·¼ìœ¡ ì¤‘ì‹¬ ê·¼ë ¥ìš´ë™ 30ë¶„", 
            detail: "ë‹¨ì‹ ì§„ì… ì´ˆê¸° ë‹¨ê³„ì—ì„œì˜ ê·¼ë ¥ ìš´ë™ì€ ë§ˆì´ì˜¤ì¹´ì¸ì„ ë¶„ë¹„ì‹œì¼œ ì „ì‹ ì˜ ì¸í¬ë ˆí‹´ ê°ìˆ˜ì„±(Î³)ì„ ë†’ì…ë‹ˆë‹¤. ê°ëŸ‰ ì¤‘ ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ ì €í•˜ë¥¼ ë§‰ëŠ” ë°©íŒ¨ì…ë‹ˆë‹¤." 
        },
        { 
            t: "22:00", title: "ë©œë¼í† ë‹Œ ì„¸ì´í”„ê°€ë“œ", pts: 5, 
            action: "ë¸”ë£¨ë¼ì´íŠ¸ ì°¨ë‹¨ ë° ì‹¤ë‚´ ì¡°ë„ ë‚®ì¶”ê¸°", 
            detail: "ë¸”ë£¨ë¼ì´íŠ¸ ì°¨ë‹¨ì€ ì¸í¬ë ˆí‹´ ë¶„ë¹„ ì£¼ê¸°ë¥¼ ì¡°ì ˆí•˜ëŠ” ë©œë¼í† ë‹Œ í•©ì„±ì„ ë•ìŠµë‹ˆë‹¤. ë°¤ì‚¬ì´ í˜¸ë¥´ëª¬ ì¬ìƒ íš¨ìœ¨ì„ ë†’ì—¬ ë‚´ì¼ ì•„ì¹¨ì˜ ëŒ€ì‚¬ ìœ ì—°ì„±ì„ ì¤€ë¹„í•©ë‹ˆë‹¤." 
        },
        { 
            t: "23:00", title: "ì‹¬ì¸µ ëŒ€ì‚¬ ë³µêµ¬ (Deep Sleep)", pts: 5, 
            action: "ì™„ì „ ì•”ë§‰ í™˜ê²½ì—ì„œ 7~8ì‹œê°„ ìˆ™ë©´", 
            detail: "ìˆ˜ë©´ ì¤‘ì—ëŠ” ì‹ìš• ì¡°ì ˆ í˜¸ë¥´ëª¬ ë ™í‹´ì´ ì •ìƒí™”ë˜ê³  ì½”ë¥´í‹°ì†”ì´ ë‚®ì•„ì§‘ë‹ˆë‹¤. ë¶€ì¡±í•œ ì ì€ ë‹¤ìŒ ë‚  ì¸í¬ë ˆí‹´ ë¯¼ê°ë„ë¥¼ ëŒ€í­ í•˜ë½ì‹œì¼œ ë¹„ì •ìƒì  í—ˆê¸°ë¥¼ ìœ ë°œí•©ë‹ˆë‹¤." 
        }
    ];

    const nudges = {
        clinical: {
            master: "ìµœì ì˜ ì¸í¬ë ˆí‹´ íš¨ìœ¨($\alpha, \beta$)ì´ ë‹¬ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ AMPK í™œì„±í™” ê²½ë¡œê°€ ì§€ë°© ì—°ì†Œë¥¼ ì£¼ë„í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            achiever: "ì•ˆì •ì  ê¶¤ë„ì…ë‹ˆë‹¤. ì‹œí€€ìŠ¤ ì‹ì‚¬ì™€ ì‚°ì±…ìœ¼ë¡œ GLP-1 ë¶„ë¹„ ì§€ì† ì‹œê°„ì„ 20% ë” ì—°ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            reset: "ëŒ€ì‚¬ ìŠ¤ìœ„ì¹˜ê°€ ì •ì²´ë˜ì—ˆìŠµë‹ˆë‹¤. 19:00 ì €ë… ë§ˆê°ì„ í†µí•œ ì¸ìŠë¦° ê¸°ì €ì¹˜ í•˜í–¥ì´ ì •ë°€ ìš”êµ¬ë©ë‹ˆë‹¤."
        },
        driver: {
            master: "ì™„ë²½í•©ë‹ˆë‹¤! ì´ ìˆœì‘ë„ë©´ ì˜ˆì¸¡ ëª¨ë¸ë³´ë‹¤ 1ì£¼ì¼ ë¹¨ë¦¬ ëª©í‘œì— ë„ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³„ì† ë°€ì–´ë¶™ì´ì„¸ìš”.",
            achiever: "ë‚˜ì˜ì§€ ì•Šì§€ë§Œ, Master ë“±ê¸‰ê¹Œì§€ ì¡°ê¸ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤. ì‹í›„ ì‚°ì±…ì„ íƒ€í˜‘í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.",
            reset: "ê²½ê³ : í˜„ì¬ ëŒ€ì‚¬ ë¦¬ë“¬ì´ ë¬´ë„ˆì¡ŒìŠµë‹ˆë‹¤. ì§€ê¸ˆ ì¦‰ì‹œ ë‹¨ì‹ ëª¨ë“œì— ì§„ì…í•˜ì—¬ ì¸ìŠë¦° ìŠ¤íŒŒì´í¬ë¥¼ ë§‰ìœ¼ì„¸ìš”!"
        },
        empathetic: {
            master: "ì˜¤ëŠ˜ ì •ë§ ê³ ìƒ ë§ìœ¼ì…¨ì–´ìš”! ëŒ€í‘œë‹˜ì˜ ë…¸ë ¥ì´ ì„¸í¬ í•˜ë‚˜í•˜ë‚˜ë¥¼ ê¹¨ìš°ê³  ìˆìŠµë‹ˆë‹¤. í¸ì•ˆí•˜ê²Œ ìˆ™ë©´í•˜ì„¸ìš”.",
            achiever: "ì°¨ê·¼ì°¨ê·¼ ì˜í•˜ê³  ê³„ì„¸ìš”. ì ì‹¬ ì‚°ì±… í•˜ë‚˜ë§Œ ë” ë”í•´ë„ ëª¸ì´ í›¨ì”¬ ê°€ë²¼ì›Œì§€ëŠ” ê±¸ ëŠë¼ì‹¤ ê±°ì˜ˆìš”.",
            reset: "ì˜¤ëŠ˜ ì¡°ê¸ˆ í˜ë“  í•˜ë£¨ì˜€ë‚˜ìš”? ê´œì°®ìŠµë‹ˆë‹¤. ë‚´ì¼ ì•„ì¹¨ í–‡ë¹› ë¦¬ì…‹ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•´ ë´ìš”. ì €í¬ê°€ ë„ìš¸ê²Œìš”."
        }
    };

    let simChart, trendChart;
    const dateInput = document.getElementById('target-date');
    dateInput.value = new Date().toISOString().split('T')[0];

    function init() { renderList(); loadAll(); renderModalContent(); }

    function renderModalContent() {
        document.getElementById('modal-guide-body').innerHTML = routine.map(r => `
            <div class="guide-step">
                <span class="guide-time">${r.t}</span>
                <span class="guide-title">${r.title}</span>
                <div class="guide-box">
                    <span class="guide-label">Action Protocol</span>
                    <p class="guide-text"><b>${r.action}</b></p>
                    <span class="guide-label" style="margin-top:10px;">Clinical Mechanism</span>
                    <p class="guide-text" style="color:var(--primary);">${r.detail}</p>
                </div>
            </div>
        `).join('');
    }

    function toggleModal(id) { const modal = document.getElementById(id); modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex'; }

    function renderList() {
        document.getElementById('routine-list').innerHTML = routine.map((item, i) => `
            <div class="item ${item.crit ? 'critical' : ''}" id="item-${i}" onclick="toggleTask(${i})">
                <div style="flex:1">
                    <span style="font-size:0.75rem; font-weight:800; color:var(--primary);">${item.t}</span>
                    <span style="display:block; font-weight:800; font-size:1rem; margin:3px 0;">${item.title}</span>
                    <div style="font-size:0.75rem; color:var(--gray);">${item.action}</div>
                </div>
                <div class="score-badge">+${item.pts}</div>
            </div>
        `).join('');
    }

    function toggleTask(i) {
        document.getElementById(`item-${i}`).classList.toggle('checked');
        saveDaily();
    }

    function saveDaily() {
        const hist = JSON.parse(localStorage.getItem('inc_v26_h') || '{}');
        const checks = routine.map((_, i) => document.getElementById(`item-${i}`).classList.contains('checked'));
        const score = routine.reduce((sum, item, i) => sum + (checks[i] ? item.pts : 0), 0);
        hist[dateInput.value] = { score, checks, weight: document.getElementById('daily-weight').value };
        localStorage.setItem('inc_v26_h', JSON.stringify(hist));
        saveProfile();
        updateTrendChart();
    }

    function saveProfile() {
        const p = { 
            start: document.getElementById('p-start').value, h: document.getElementById('p-h').value, 
            sw: document.getElementById('p-sw').value, cw: document.getElementById('p-cw').value, 
            gw: document.getElementById('p-gw').value, isDiabetic: document.getElementById('p-diabetic').value, 
            exercise: document.getElementById('p-exercise').value
        };
        localStorage.setItem('inc_v26_p', JSON.stringify(p));
    }

    function loadAll() {
        const p = JSON.parse(localStorage.getItem('inc_v26_p') || '{}');
        if(p.start) {
            document.getElementById('p-start').value = p.start; document.getElementById('p-h').value = p.h;
            document.getElementById('p-sw').value = p.sw; document.getElementById('p-cw').value = p.cw;
            document.getElementById('p-gw').value = p.gw; document.getElementById('p-diabetic').value = p.isDiabetic;
            document.getElementById('p-exercise').value = p.exercise;
        }
        const hist = JSON.parse(localStorage.getItem('inc_v26_h') || '{}');
        const data = hist[dateInput.value];
        routine.forEach((_, i) => {
            const el = document.getElementById(`item-${i}`);
            if(data && data.checks[i]) el.classList.add('checked'); else el.classList.remove('checked');
        });
        document.getElementById('daily-weight').value = (data && data.weight) ? data.weight : '';
        updateTrendChart();
    }

    function updateTrendChart() {
        const hist = JSON.parse(localStorage.getItem('inc_v26_h') || '{}');
        const sortedDates = Object.keys(hist).sort();
        const weights = sortedDates.map(d => hist[d].weight).filter(w => w);
        const labels = sortedDates.filter(d => hist[d].weight).map(d => d.slice(5));

        if(weights.length > 0) {
            document.getElementById('trend-view').style.display = 'block';
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(trendChart) trendChart.destroy();
            trendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ data: weights, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true, tension: 0.3, pointRadius: 4 }] },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
            });
        }
        refreshStats(hist);
    }

    function refreshStats(hist) {
        const h = parseFloat(document.getElementById('p-h').value) / 100;
        const cw = parseFloat(document.getElementById('p-cw').value);
        const sw = parseFloat(document.getElementById('p-sw').value);
        const gw = parseFloat(document.getElementById('p-gw').value);

        if(h > 0 && cw > 0) document.getElementById('bmi-v').innerText = (cw / (h * h)).toFixed(1);
        if(sw && gw && cw) document.getElementById('ach-v').innerText = Math.max(0, Math.min(100, ((sw - cw) / (sw - gw)) * 100)).toFixed(1) + '%';

        const currentScore = (hist[dateInput.value] && hist[dateInput.value].score) || 0;
        document.getElementById('today-score').innerText = currentScore;
        document.getElementById('burn-rate').innerText = Math.min(100, Math.round(currentScore * 1.15)) + "%";

        updateAIStatus(currentScore);
    }

    function updateAIStatus(score = null) {
        if(score === null) score = parseInt(document.getElementById('today-score').innerText);
        const persona = document.getElementById('ai-persona').value;
        const nudgeEl = document.getElementById('ai-nudge');
        let state = "reset";
        if(score >= 85) state = "master"; else if(score >= 60) state = "achiever";
        nudgeEl.innerText = nudges[persona][state];
    }

    function runComprehensiveAnalysis() {
        const cw = parseFloat(document.getElementById('p-cw').value);
        const isDiabetic = document.getElementById('p-diabetic').value === 'yes';
        const exCount = parseInt(document.getElementById('p-exercise').value);
        const avgScore = parseInt(document.getElementById('today-score').innerText) || 80;

        document.getElementById('sim-view').style.display = 'block';
        const alpha = isDiabetic ? 0.75 : 1.15;
        const beta = avgScore >= 85 ? 1.35 : 1.0;
        const gamma = 1 + (Math.min(exCount, 5) * 0.05);

        let labels = ["í˜„ì¬"], weights = [cw], tempW = cw;
        for (let w = 1; w <= 4; w++) {
            tempW -= (w === 1 ? 1.6 : 0.8) * alpha * beta * gamma;
            labels.push(w + "ì£¼");
            weights.push(tempW.toFixed(1));
        }

        const ctx = document.getElementById('simChart').getContext('2d');
        if(simChart) simChart.destroy();
        simChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ data: weights, borderColor: '#10b981', borderDash: [4, 4], tension: 0.4 }] },
            options: { plugins: { legend: { display: false } } }
        });
        saveDaily();
    }

    function exportToExcel() {
        const p = JSON.parse(localStorage.getItem('inc_v26_p') || '{}');
        const h = JSON.parse(localStorage.getItem('inc_v26_h') || '{}');
        const heightM = parseFloat(p.h) / 100;
        const data = Object.keys(h).sort().map(date => {
            const w = parseFloat(h[date].weight) || 0;
            return { "ë‚ ì§œ": date, "ë£¨í‹´ì ìˆ˜": h[date].score, "ì²´ì¤‘(kg)": w, "BMI": w > 0 ? (w / (heightM * heightM)).toFixed(1) : "-", "ì‹¤ì²œë‚´ìš©": h[date].checks.map((c, i) => c ? routine[i].title : null).filter(v => v).join(", ") };
        });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([p]), "User_Profile");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "Metabolic_Clinical_Log");
        XLSX.writeFile(wb, `IncretinA_i_v2.6_ClinicalData.xlsx`);
    }

    dateInput.addEventListener('change', loadAll);
    document.getElementById('daily-weight').addEventListener('input', saveDaily);
    window.onload = init;
</script>
</body>
</html>
