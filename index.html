<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incretin Master Pro: Advanced v2.5.1</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        :root {
            --primary: #2563eb; --success: #10b981; --danger: #ef4444; --gray: #64748b; --dark: #0f172a; --accent: #fbbf24;
        }
        body { font-family: 'Pretendard', sans-serif; background: #f8fafc; color: var(--dark); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 800px; width: 100%; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; width: 100%; }
        
        .help-btn { 
            background: var(--accent); color: var(--dark); border: none; width: 50px; height: 50px; border-radius: 18px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
            transition: 0.3s;
        }
        .help-btn:hover { transform: scale(1.1) rotate(5deg); }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; width: 100%; }
        .stat-item { background: white; padding: 15px; border-radius: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; }
        .stat-val { display: block; font-size: 1.4rem; font-weight: 800; color: var(--primary); }
        .stat-lbl { font-size: 0.75rem; color: var(--gray); font-weight: 600; margin-bottom: 4px; display: block; }

        .ai-card { background: white; border-radius: 24px; padding: 25px; margin-bottom: 25px; border: 2px solid var(--primary); box-shadow: 0 10px 25px rgba(37, 99, 235, 0.1); width: 100%; box-sizing: border-box; }
        .ai-title { font-weight: 800; color: var(--primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; }
        .ai-content { background: #f8fafc; padding: 15px; border-radius: 12px; font-size: 0.9rem; line-height: 1.6; border-left: 4px solid var(--primary); }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; width: 100%; }
        .chart-card { background: white; border-radius: 24px; padding: 20px; border: 2px solid #e2e8f0; }
        .chart-title { font-size: 0.8rem; font-weight: 800; margin-bottom: 10px; display: block; color: var(--gray); }

        .glass-card { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 25px; width: 100%; box-sizing: border-box; }
        .profile-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .input-group label { font-size: 0.7rem; font-weight: 700; color: var(--gray); display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; font-family: inherit; font-weight: 600; box-sizing: border-box; }

        .item { background: white; border-radius: 20px; padding: 18px; margin-bottom: 12px; display: flex; gap: 12px; border-left: 6px solid #cbd5e1; cursor: pointer; transition: 0.3s; position: relative; }
        .item.checked { background: #f0fdf4; border-left-color: var(--success); }
        .item.critical { border-left-color: var(--danger); }

        .btn { padding: 16px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; transition: 0.3s; color: white; text-align: center; }
        .btn-primary { background: var(--primary); width: 100%; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 95%; max-width: 600px; padding: 30px; border-radius: 24px; max-height: 80vh; overflow-y: auto; }
        .guide-h { font-size: 1.1rem; font-weight: 800; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 5px; margin: 20px 0 10px; }
        .guide-sec { font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px; }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1 style="color: var(--primary); margin: 0; font-size: 1.6rem;">ğŸ§¬ ì¸í¬ë ˆí‹´ ë§ˆìŠ¤í„° Pro</h1>
            <p style="color: var(--gray); font-size: 0.85rem; margin-top: 5px;">v2.5 Precision Analytics & Clinical Logic</p>
        </div>
        <button class="help-btn no-print" onclick="toggleHelpModal()" title="ì •ë°€ í–‰ë™ ì„¤ê³„ ê°€ì´ë“œ">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A5 5 0 0 0 8 8c0 1.3.5 2.6 1.5 3.5.8.8 1.3 1.5 1.5 2.5"></path><line x1="9" y1="18" x2="15" y2="18"></line><line x1="10" y1="22" x2="14" y2="22"></line></svg>
        </button>
    </header>

    <div class="stat-grid no-print">
        <div class="stat-item"><span class="stat-lbl">í˜„ì¬ BMI</span><span class="stat-val" id="bmi-v">0.0</span></div>
        <div class="stat-item"><span class="stat-lbl">ëª©í‘œ ë‹¬ì„±ë¥ </span><span class="stat-val" id="ach-v" style="color:var(--danger);">0%</span></div>
        <div class="stat-item"><span class="stat-lbl">ì£¼ê°„ ìˆœì‘ë„</span><span class="stat-val" id="avg-v" style="color:var(--success);">0</span></div>
    </div>

    <div class="ai-card">
        <div class="ai-title">ğŸ©º ì¸í¬ë ˆí‹´ AI í–‰ë™ ì²˜ë°©</div>
        <div id="ai-rx" class="ai-content">ë°ì´í„°ë¥¼ ì…ë ¥í•˜ë©´ ì„ìƒ ëª¨ë¸ ê¸°ë°˜ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.</div>
    </div>

    <div class="dashboard-grid no-print">
        <div class="chart-card" id="sim-view" style="display:none; border-color: var(--success);">
            <span class="chart-title">ğŸ“‰ 4ì£¼ ì˜ˆì¸¡ ê³¡ì„ </span>
            <canvas id="simChart" height="200"></canvas>
        </div>
        <div class="chart-card" id="trend-view" style="display:none; border-color: var(--primary);">
            <span class="chart-title">ğŸ“ˆ ì‹¤ì œ ì²´ì¤‘ ì¶”ì´</span>
            <canvas id="trendChart" height="200"></canvas>
        </div>
    </div>

    <div class="glass-card">
        <div class="profile-grid no-print">
            <div class="input-group"><label>ì±Œë¦°ì§€ ì‹œì‘ì¼</label><input type="date" id="p-start"></div>
            <div class="input-group"><label>ë‹¹ë‡¨ ìœ ë¬´</label><select id="p-diabetic"><option value="no">ë¹„ë‹¹ë‡¨ì¸</option><option value="yes">ë‹¹ë‡¨(ì œ2í˜•)</option></select></div>
            <div class="input-group"><label>í‚¤ (cm)</label><input type="number" id="p-h" value="175"></div>
            <div class="input-group"><label>ì‹œì‘ ì²´ì¤‘(kg)</label><input type="number" id="p-sw" step="0.1" value="80"></div>
            <div class="input-group"><label>í˜„ì¬ ì²´ì¤‘(kg)</label><input type="number" id="p-cw" step="0.1" value="78"></div>
            <div class="input-group"><label>ëª©í‘œ ì²´ì¤‘(kg)</label><input type="number" id="p-gw" step="0.1" value="70"></div>
            <div class="input-group"><label>ì£¼ê°„ ìš´ë™(íšŒ)</label><input type="number" id="p-exercise" value="3"></div>
        </div>
        <button class="btn btn-primary" onclick="runComprehensiveAnalysis()">ë¶„ì„ ì‹¤í–‰ ë° ë°ì´í„° ê°±ì‹ </button>
    </div>

    <div class="glass-card no-print" style="border-top: 4px solid var(--primary);">
        <div style="display:flex; gap:10px; align-items: flex-end; margin-bottom:15px;">
            <div style="flex:1;"><label style="font-size:0.7rem; font-weight:700; color:var(--gray);">ê¸°ë¡ ë‚ ì§œ</label><input type="date" id="target-date"></div>
            <div style="flex:1;"><label style="font-size:0.7rem; font-weight:700; color:var(--gray);">ì˜¤ëŠ˜ ì²´ì¤‘(kg)</label><input type="number" id="daily-weight" step="0.1" placeholder="00.0"></div>
        </div>
        <div id="routine-list"></div>
        <button class="btn" style="background:var(--success); width:100%; margin-top:20px;" onclick="exportToExcel()">ğŸ“Š ì„ìƒ ë°ì´í„° Excel ì¶”ì¶œ</button>
    </div>
</div>

<div id="help-modal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--primary); margin-top:0; display:flex; align-items:center; gap:10px;">ğŸ’¡ IMEM ì •ë°€ í–‰ë™ ì„¤ê³„ ê°€ì´ë“œ</h2>
        <div id="modal-body-content"></div>
        <button class="btn btn-primary" style="margin-top:20px;" onclick="toggleHelpModal()">ê°€ì´ë“œ ë‹«ê¸°</button>
    </div>
</div>

<script>
    // [í–‰ë™ì–‘ì‹ ë° í•µì‹¬ ê¸°ì „ êµ¬ì²´í™”]
    const routine = [
        { 
            t: "07:00", title: "ìƒì²´ ë¦¬ë“¬ ë¦¬ì…‹", 
            action: "ê¸°ìƒ 10ë¶„ ë‚´ ì§ì‚¬ê´‘ì„  5ë¶„ ë…¸ì¶œ + ë¯¸ì˜¨ìˆ˜ 300ml ì„­ì·¨", 
            detail: "ì•„ì¹¨ í–‡ì‚´ì€ ë©œë¼í† ë‹Œ ë¶„ë¹„ë¥¼ ì¦‰ì‹œ ì°¨ë‹¨í•˜ê³  ì„¸ë¡œí† ë‹Œ í•©ì„±ì„ ë„ì™€ ìƒì²´ ì‹œê³„ë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤. ì´ëŠ” ì˜¤ì „ ì¸í¬ë ˆí‹´ ë¶„ë¹„ ë¯¼ê°ë„ë¥¼ ê²°ì •í•˜ëŠ” ê¸°ì´ˆ ê³µì‚¬ì…ë‹ˆë‹¤.", 
            pts: 5 
        },
        { 
            t: "11:00", title: "í˜¸ë¥´ëª¬ í”„ë¦¬ë¡œë“œ (í•µì‹¬)", 
            action: "ë‹¨ë°±ì§ˆ 15g(ë‹¬ê±€ 2ê°œ ë¶„ëŸ‰) ë˜ëŠ” PHGG ì‹ì´ì„¬ìœ  5g ì„­ì·¨", 
            detail: "ì‹ì‚¬ 30ë¶„ ì „ ìœ ë°œ ë‹¨ë°±ì§ˆì€ ì†Œì¥ í•˜ë¶€ì˜ L-ì„¸í¬ë¥¼ ìê·¹í•´ ì¸í¬ë ˆí‹´ì„ ì„ ì œì ìœ¼ë¡œ ë¶„ë¹„ì‹œí‚µë‹ˆë‹¤. ì‹í›„ í˜ˆë‹¹ ìŠ¤íŒŒì´í¬ë¥¼ ë°©ì–´í•˜ëŠ” 'í˜¸ë¥´ëª¬ ë°©íŒŒì œ' ì—­í• ì„ í•©ë‹ˆë‹¤.", 
            pts: 10, crit: true 
        },
        { 
            t: "11:30", title: "ì¸í¬ë ˆí‹´ ì‹œí€€ìŠ¤ ì‹ì‚¬", 
            action: "ì‹ì´ì„¬ìœ (ì±„ì†Œ) â†’ ë‹¨ë°±ì§ˆ/ì§€ë°© â†’ íƒ„ìˆ˜í™”ë¬¼ ìˆœì„œ ê³ ìˆ˜", 
            detail: "ì‹ì´ì„¬ìœ ê°€ ìœ„ ë°°ì¶œ ì†ë„ë¥¼ ì§€ì—°ì‹œí‚¤ê³  íƒ„ìˆ˜í™”ë¬¼ í¡ìˆ˜ ì†ë„ë¥¼ ë¬¼ë¦¬ì ìœ¼ë¡œ ëŠ¦ì¶° ì¸í¬ë ˆí‹´ íš¨ìœ¨ì„ 30% ì´ìƒ ë†’ì´ë©° ì§€ë°© ì—°ì†Œ ëª¨ë“œë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.", 
            pts: 15, crit: true 
        },
        { 
            t: "11:50", title: "ê¸€ë£¨ì½”ìŠ¤ í´ë¦¬ì–´ëŸ°ìŠ¤ ì‚°ì±…", 
            action: "ì‹í›„ 40ë¶„ ì´ë‚´, ìˆ¨ì´ ì•½ê°„ ì°° ì •ë„ì˜ ì†ë³´ë¡œ ê±·ê¸°", 
            detail: "ì¸ìŠë¦°ì˜ ë„ì›€ ì—†ì´ë„ ê·¼ìœ¡ì˜ GLUT4 ìˆ˜ìš©ì²´ê°€ í˜ˆì•¡ ë‚´ í¬ë„ë‹¹ì„ ì§ì ‘ ì—°ì†Œì‹œí‚¤ëŠ” ë§ˆë²•ì˜ ì‹œê°„ì…ë‹ˆë‹¤. 40ë¶„ ê±·ê¸°ëŠ” í—¬ìŠ¤ì¥ 1ì‹œê°„ë³´ë‹¤ í˜ˆë‹¹ ì•ˆì •í™”ì— ê°•ë ¥í•©ë‹ˆë‹¤.", 
            pts: 15, crit: true 
        },
        { 
            t: "17:30", title: "ëŒ€ì‚¬ ìŠ¤ìœ„ì¹˜ OFF (ì €ë… ë§ˆê°)", 
            action: "18:00 ì´ì „ ì‹ì‚¬ ì™„ë£Œ í›„ ì•¼ê°„ 16ì‹œê°„ ë‹¨ì‹ ì§„ì…", 
            detail: "ì €ë… ë§ˆê°ì€ ì•¼ê°„ ì¸ìŠë¦° ìˆ˜ì¹˜ë¥¼ ìµœì €ë¡œ ë‚®ì¶”ì–´ ëª¸ì„ 'ì €ì¥ ëª¨ë“œ'ì—ì„œ 'ì§€ë°© ì—°ì†Œ ëª¨ë“œ'ë¡œ ê°•ì œ ì „í™˜ì‹œí‚µë‹ˆë‹¤. ìˆ˜ë©´ ì¤‘ ëŒ€ì‚¬ íš¨ìœ¨ì„ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.", 
            pts: 20, crit: true 
        },
        { 
            t: "20:00", title: "ê·¼ìœ¡ ë°©ì–´ (Muscle Shield)", 
            action: "í—ˆë²…ì§€/ì½”ì–´ ì¤‘ì‹¬ì˜ ì €í•­ì„±(ê·¼ë ¥) ìš´ë™ 30ë¶„ ì‹¤ì²œ", 
            detail: "ê°ëŸ‰ ì¤‘ ê·¼ì†ì‹¤ ë°©ì–´ ê³„ìˆ˜(Î³)ë¥¼ ì‚¬ìˆ˜í•˜ì—¬ ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ ì €í•˜ë¥¼ ë§‰ìŠµë‹ˆë‹¤. ê·¼ìœ¡ì€ í˜ˆë‹¹ì„ íƒœìš°ëŠ” ê°€ì¥ íš¨ìœ¨ì ì¸ ìš©ê´‘ë¡œì…ë‹ˆë‹¤.", 
            pts: 15 
        },
        { 
            t: "23:00", title: "í˜¸ë¥´ëª¬ ë³µêµ¬ ìˆ˜ë©´", 
            action: "ì™„ì „ ì•”ë§‰ ìƒíƒœì—ì„œ 7ì‹œê°„ ì´ìƒ ì–‘ì§ˆì˜ ìˆ™ë©´", 
            detail: "ê¹Šì€ ìˆ˜ë©´ì€ ì‹ìš• ì–µì œ í˜¸ë¥´ëª¬ ë ™í‹´ì„ ì •ìƒí™”í•˜ê³  ìŠ¤íŠ¸ë ˆìŠ¤ í˜¸ë¥´ëª¬ ì½”ë¥´í‹°ì†”ì„ ë‚®ì¶”ì–´ ë‚´ì¼ì˜ ìµœì  ëŒ€ì‚¬ í™˜ê²½ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.", 
            pts: 10 
        }
    ];

    let simChart, trendChart;
    const dateInput = document.getElementById('target-date');
    dateInput.value = new Date().toISOString().split('T')[0];

    function init() {
        renderList();
        loadAll();
        renderModalContent(); // ëª¨ë‹¬ ê°€ì´ë“œ ë‚´ìš© ìƒì„±
    }

    function renderModalContent() {
        const html = routine.map(r => `
            <div class="guide-h">${r.t} | ${r.title}</div>
            <div class="guide-sec">
                â€¢ <b>ìƒì„¸ í–‰ë™ ê°€ì´ë“œ:</b> ${r.action}<br>
                â€¢ <b>í•µì‹¬ ì„ìƒ ê¸°ì „:</b> ${r.detail}
            </div>
        `).join('');
        document.getElementById('modal-body-content').innerHTML = html;
    }

    function toggleHelpModal() {
        const modal = document.getElementById('help-modal');
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

    function renderList() {
        document.getElementById('routine-list').innerHTML = routine.map((item, i) => `
            <div class="item ${item.crit ? 'critical' : ''}" onclick="toggleTask(${i})">
                <input type="checkbox" id="task-${i}" style="width:22px; height:22px;">
                <div style="flex:1">
                    <span style="font-size:0.75rem; font-weight:800; color:var(--primary);">${item.t} í•µì‹¬í–‰ë™</span>
                    <span style="display:block; font-weight:800; font-size:1rem; margin:3px 0;">${item.title}</span>
                    <div style="font-size:0.75rem; color:var(--gray); line-height:1.4;">${item.action}</div>
                    <span style="position:absolute; right:20px; top:20px; font-weight:800; color:var(--success);">+${item.pts}</span>
                </div>
            </div>
        `).join('');
    }

    function toggleTask(i) {
        const cb = document.getElementById(`task-${i}`);
        cb.checked = !cb.checked;
        saveDaily();
    }

    function saveDaily() {
        const hist = JSON.parse(localStorage.getItem('inc_advanced_h') || '{}');
        const checks = routine.map((_, i) => document.getElementById(`task-${i}`).checked);
        const score = routine.reduce((sum, item, i) => sum + (checks[i] ? item.pts : 0), 0);
        const weight = document.getElementById('daily-weight').value;
        hist[dateInput.value] = { score, checks, weight };
        localStorage.setItem('inc_advanced_h', JSON.stringify(hist));
        saveProfile();
        updateTrendChart();
    }

    function saveProfile() {
        const p = { 
            start: document.getElementById('p-start').value, h: document.getElementById('p-h').value, 
            sw: document.getElementById('p-sw').value, cw: document.getElementById('p-cw').value, 
            gw: document.getElementById('p-gw').value, isDiabetic: document.getElementById('p-diabetic').value, 
            exercise: document.getElementById('p-exercise').value
        };
        localStorage.setItem('inc_advanced_p', JSON.stringify(p));
    }

    function loadAll() {
        const p = JSON.parse(localStorage.getItem('inc_advanced_p') || '{}');
        if(p.start) {
            document.getElementById('p-start').value = p.start;
            document.getElementById('p-h').value = p.h;
            document.getElementById('p-sw').value = p.sw;
            document.getElementById('p-cw').value = p.cw;
            document.getElementById('p-gw').value = p.gw;
            document.getElementById('p-diabetic').value = p.isDiabetic;
            document.getElementById('p-exercise').value = p.exercise;
        }
        const hist = JSON.parse(localStorage.getItem('inc_advanced_h') || '{}');
        const data = hist[dateInput.value];
        routine.forEach((_, i) => document.getElementById(`task-${i}`).checked = data ? data.checks[i] : false);
        document.getElementById('daily-weight').value = (data && data.weight) ? data.weight : '';
        updateTrendChart();
    }

    function updateTrendChart() {
        const hist = JSON.parse(localStorage.getItem('inc_advanced_h') || '{}');
        const sortedDates = Object.keys(hist).sort();
        const weights = sortedDates.map(d => hist[d].weight).filter(w => w);
        const labels = sortedDates.filter(d => hist[d].weight).map(d => d.slice(5));

        if(weights.length > 0) {
            document.getElementById('trend-view').style.display = 'block';
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(trendChart) trendChart.destroy();
            trendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'ì‹¤ì œì²´ì¤‘(kg)', data: weights, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true, tension: 0.3, pointRadius: 4 }] },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
            });
        }
        refreshStats(hist);
    }

    function refreshStats(hist) {
        const h = parseFloat(document.getElementById('p-h').value) / 100;
        const cw = parseFloat(document.getElementById('p-cw').value);
        const sw = parseFloat(document.getElementById('p-sw').value);
        const gw = parseFloat(document.getElementById('p-gw').value);

        if(h > 0 && cw > 0) document.getElementById('bmi-v').innerText = (cw / (h * h)).toFixed(1);
        if(sw && gw && cw) {
            const ach = Math.max(0, Math.min(100, ((sw - cw) / (sw - gw)) * 100));
            document.getElementById('ach-v').innerText = ach.toFixed(1) + '%';
        }

        const scores = Object.values(hist).map(d => d.score);
        const avg = scores.length ? Math.round(scores.reduce((a,b)=>a+b)/scores.length) : 0;
        document.getElementById('avg-v').innerText = avg;
        
        const rx = document.getElementById('ai-rx');
        if(avg >= 85) rx.innerHTML = "<b>[Master]</b> ì¸í¬ë ˆí‹´ íš¨ìœ¨ ê·¹ëŒ€í™” ìƒíƒœì…ë‹ˆë‹¤. ì €ë… ì¡°ê¸° ë§ˆê°ì´ ë°¤ì‚¬ì´ ì§€ë°© ì—°ì†Œë¥¼ ë•ìŠµë‹ˆë‹¤.";
        else rx.innerHTML = "<b>[Achiever]</b> ì•ˆì •ì  ê¶¤ë„ì…ë‹ˆë‹¤. í”„ë¦¬ë¡œë“œ ì‹¤ì²œìœ¨ì„ ë†’ì—¬ ì¸ìŠë¦° ì €í•­ì„±ì„ ê°œì„ í•˜ì„¸ìš”.";
    }

    function runComprehensiveAnalysis() {
        const cw = parseFloat(document.getElementById('p-cw').value);
        const isDiabetic = document.getElementById('p-diabetic').value === 'yes';
        const exCount = parseInt(document.getElementById('p-exercise').value);
        
        document.getElementById('sim-view').style.display = 'block';
        const alpha = isDiabetic ? 0.75 : 1.15;
        const gamma = 1 + (Math.min(exCount, 5) * 0.05);

        let labels = ["í˜„ì¬"], weights = [cw], tempW = cw;
        for (let w = 1; w <= 4; w++) {
            tempW -= (w === 1 ? 1.6 : 0.8) * alpha * gamma;
            labels.push(w + "ì£¼");
            weights.push(tempW.toFixed(1));
        }

        const ctx = document.getElementById('simChart').getContext('2d');
        if(simChart) simChart.destroy();
        simChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ data: weights, borderColor: '#10b981', borderDash: [4, 4], tension: 0.4 }] },
            options: { plugins: { legend: { display: false } } }
        });
        saveDaily();
    }

    function exportToExcel() {
        const p = JSON.parse(localStorage.getItem('inc_advanced_p') || '{}');
        const h = JSON.parse(localStorage.getItem('inc_advanced_h') || '{}');
        const heightM = parseFloat(p.h) / 100;
        
        const data = Object.keys(h).sort().map(date => {
            const weight = parseFloat(h[date].weight) || 0;
            return {
                "ë‚ ì§œ": date,
                "ë£¨í‹´ì ìˆ˜": h[date].score,
                "ê¸°ë¡ì²´ì¤‘(kg)": weight,
                "ì‹¤ì‹œê°„ BMI": weight > 0 ? (weight / (heightM * heightM)).toFixed(1) : "-",
                "ì‹¤ì²œí•­ëª©": h[date].checks.map((c, i) => c ? routine[i].title : null).filter(v => v).join(", ")
            };
        });

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([p]), "User_Profile");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "Metabolic_Clinical_Log");
        XLSX.writeFile(wb, `IncretinMasterPro_v2.5_RWE_Data.xlsx`);
    }

    dateInput.addEventListener('change', loadAll);
    document.getElementById('daily-weight').addEventListener('input', saveDaily);
    window.onload = init;
</script>
</body>
</html>


